# ATRI 自动重启插件

为ATRI机器人提供完整的自动重启功能，包括定时重启和手动重启控制。

## ✨ 功能特性

### 🔄 自动重启
- **定时重启**：支持每日定时自动重启（默认凌晨4点）
- **智能调度**：使用 APScheduler 实现精确定时任务
- **可配置时间**：通过配置文件自定义重启时间

### 🎛️ 手动控制
- **QQ命令重启**：超级用户可通过QQ命令立即重启
- **优雅关闭**：发送SIGTERM信号实现安全关闭
- **状态查询**：实时查看重启系统运行状态

### 📊 状态监控
- **运行时长统计**：精确记录机器人运行时间
- **重启次数记录**：统计历史重启次数和原因
- **详细日志**：完整记录重启过程和状态变化

### 🔔 通知系统
- **可靠通知**：机器人与QQ服务器成功连接后，自动向超级用户发送通知
- **详细信息**：通知包含重启原因、时间、运行时长、总重启次数
- **智能发送**：发送成功后标记状态，避免重复发送。如果发送失败（如机器人离线），则会在下次连接成功后自动重试
- **可配置**：支持在配置文件中启用或禁用此功能

### 🛡️ 安全可靠
- **进程独立**：重启子进程独立于主进程，确保重启成功
- **多重检查**：环境检测、依赖验证、插件状态检查
- **错误处理**：完善的异常处理和故障恢复机制
- **虚拟环境支持**：自动检测并激活Python虚拟环境

### ⚙️ 灵活配置
- **JSON配置**：通过配置文件轻松调整所有参数
- **脚本自定义**：支持自定义启动脚本路径
- **延迟设置**：可配置重启延迟时间
- **尝试次数控制**：设置最大重启尝试次数

## 📋 命令列表

### 重启相关命令（仅超级用户）

| 命令 | 别名 | 功能 |
|------|------|------|
| `@机器人 重启` | `restart`, `重启机器人`, `重新启动` | 立即重启机器人 |
| `@机器人 重启状态` | `restart_status`, `重启信息` | 查看重启系统状态 |
| `@机器人 重启配置` | `restart_config`, `配置重启` | 管理重启配置 |

### 配置命令详细说明

```bash
# 查看当前配置
@机器人 重启配置

# 启用/禁用自动重启
@机器人 重启配置 启用
@机器人 重启配置 禁用

# 设置重启时间（24小时制）
@机器人 重启配置 时间 04:00
@机器人 重启配置 时间 02:30
```

### 3. QQ命令

在QQ中使用以下命令（需要@机器人，仅超级用户可用）：

#### `@机器人 重启状态`
查询重启系统详细状态，包含：
- 系统配置信息（自动重启、重启时间、通知设置等）
- 运行状态信息（最后启动/重启时间、运行时长、重启次数等）
- 通知状态信息（通知发送状态和时间）

#### `@机器人 重启配置`
查看和修改重启系统配置

#### `@机器人 重启`
立即执行重启操作，机器人会：
1. 发送"🔄 准备重启机器人..."提示
2. 等待3秒让用户看到回复
3. 执行安全重启流程
4. 重启完成后，待机器人与QQ服务器成功连接，将发送通知（如果启用）

## 📁 文件结构

```
plugins/restart/              # 重启插件目录
├── __init__.py              # 插件主入口
├── config.py                # 配置管理
├── restart_manager.py       # 重启管理器
└── README.md               # 说明文档

scripts/restart/             # 重启脚本目录
├── restart.sh              # 重启系统主入口（推荐使用）
├── start_bot.sh           # 机器人启动脚本
├── test_restart.sh        # 环境检测脚本
└── check_restart_plugin.sh  # 插件状态检查脚本

data/restart/              # 重启数据目录
├── config.json           # 重启配置文件
└── status.json           # 重启状态记录
```

## ⚙️ 配置说明

重启系统支持通过配置文件 `data/restart/config.json` 进行个性化设置：

```json
{
  "auto_restart_enabled": true,
  "restart_time": "04:00", 
  "startup_script_path": "scripts/restart/start_bot.sh",
  "max_restart_attempts": 3,
  "restart_delay": 5,
  "restart_notification_enabled": true
}
```

### 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `auto_restart_enabled` | bool | `true` | 是否启用自动重启功能 |
| `restart_time` | string | `"04:00"` | 每日自动重启时间（24小时制） |
| `startup_script_path` | string | `"scripts/restart/start_bot.sh"` | 机器人启动脚本路径 |
| `max_restart_attempts` | int | `3` | 最大重启尝试次数 |
| `restart_delay` | int | `5` | 重启延迟时间（秒） |
| `restart_notification_enabled` | bool | `true` | 是否启用重启完成通知 |

### 🔔 重启完成通知

当 `restart_notification_enabled` 为 `true` 时，机器人重启完成后会自动向所有超级用户发送通知消息，包含：

- 重启原因
- 重启时间  
- 当前运行时长
- 总重启次数

通知消息示例：
```
🎉 机器人重启完成通知

🔹 重启原因: 定时重启
🔹 重启时间: 2025-01-15 04:00:12
🔹 当前运行时长: 2分钟
🔹 总重启次数: 17

✅ 系统已恢复正常运行！
```

## 🔧 快速开始

### 1. 环境检查和启动

```bash
# 检查环境和依赖
./scripts/restart/restart.sh test

# 启动机器人
./scripts/restart/restart.sh start

# 检查插件状态
./scripts/restart/restart.sh check

# 查看运行状态
./scripts/restart/restart.sh status
```

### 2. 功能测试

在QQ中发送给机器人（需要超级用户权限）：
- `@机器人 重启状态` - 查看系统状态
- `@机器人 重启配置` - 查看/修改配置
- `@机器人 重启` - 立即重启

## 📊 状态监控

### 重启状态信息

使用 `@机器人 重启状态` 可以查看：

- 🔄 自动重启开关状态
- ⏰ 当前设置的重启时间
- 📁 启动脚本路径
- 📅 最后重启时间
- ⏱️ 当前运行时长
- 🔢 历史重启次数

### 日志信息

```bash
# 查看最新日志
tail -f logs/$(ls logs/ | tail -1)

# 搜索重启相关日志
grep "重启" logs/*.log

# 查看重启过程日志
cat /tmp/atri_restart.log
```

## 🛡️ 安全特性

1. **权限控制**: 只有超级用户可以执行重启相关命令
2. **安全关闭**: 重启前会安全关闭当前进程，避免数据丢失
3. **状态记录**: 记录所有重启操作的时间和原因
4. **脚本清理**: 临时重启脚本会自动清理

### 通知未发送

如果重启后没有收到通知，请检查：

1. **功能是否启用**：检查 `data/restart/config.json` 中的 `restart_notification_enabled` 是否为 `true`。
2. **超级用户配置**：检查 `NoneBot` 的配置文件中是否已正确设置 `superusers`。
3. **机器人连接状态**：查看最新日志，确认机器人是否成功与QQ服务器建立连接。
4. **日志错误信息**：在日志中搜索 "发送重启通知失败"，查看具体错误原因。

## 🔍 故障排除

### 重启失败

如果重启失败，检查：

1. 启动脚本是否有执行权限
2. 虚拟环境路径是否正确
3. screen是否已安装
4. 查看重启日志：`cat /tmp/atri_restart.log`

### 定时任务不工作

检查：

1. 自动重启是否已启用
2. 时间格式是否正确（HH:MM）
3. 系统时区设置是否正确

### 脚本权限问题

```bash
# 添加执行权限
chmod +x scripts/restart/start_bot.sh
chmod +x scripts/restart/restart.sh
```

## 📝 重要说明

**注意**: 重启功能会完全关闭并重新启动机器人进程，正在进行的对话可能会被中断。建议在非繁忙时段使用。

---

**系统特性**:
- 自动检测并激活虚拟环境（`.venv`）
- 自动管理screen会话（默认会话名：`atri`）
- 安全的会话替换（关闭旧会话，启动新会话）
- 完整的错误处理和日志记录 