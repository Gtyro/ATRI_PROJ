# ATRI 自动重启插件

为ATRI机器人提供完整的自动重启功能，包括定时重启和手动重启控制。

## 🚀 功能特性

- **🕐 定时重启**: 每日定时自动重启（默认凌晨4点）
- **🎮 手动控制**: 超级用户可通过命令手动重启
- **📊 状态监控**: 实时查看重启系统状态和历史记录
- **⚙️ 灵活配置**: 可自定义重启时间和相关参数
- **🔒 安全重启**: 安全的关闭流程，确保数据不丢失

## 📋 命令列表

### 重启相关命令（仅超级用户）

| 命令 | 别名 | 功能 |
|------|------|------|
| `@机器人 重启` | `restart`, `重启机器人`, `重新启动` | 立即重启机器人 |
| `@机器人 重启状态` | `restart_status`, `重启信息` | 查看重启系统状态 |
| `@机器人 重启配置` | `restart_config`, `配置重启` | 管理重启配置 |

### 配置命令详细说明

```bash
# 查看当前配置
@机器人 重启配置

# 启用/禁用自动重启
@机器人 重启配置 启用
@机器人 重启配置 禁用

# 设置重启时间（24小时制）
@机器人 重启配置 时间 04:00
@机器人 重启配置 时间 02:30
```

## 📁 文件结构

```
plugins/restart/              # 重启插件目录
├── __init__.py              # 插件主入口
├── config.py                # 配置管理
├── restart_manager.py       # 重启管理器
└── README.md               # 说明文档

scripts/restart/             # 重启脚本目录
├── restart.sh              # 重启系统主入口（推荐使用）
├── start_bot.sh           # 机器人启动脚本
├── test_restart.sh        # 环境检测脚本
└── check_restart_plugin.sh  # 插件状态检查脚本

data/restart/              # 重启数据目录
├── config.json           # 重启配置文件
└── status.json           # 重启状态记录
```

## ⚙️ 配置说明

### 默认配置

```json
{
  "auto_restart_enabled": true,     // 是否启用自动重启
  "restart_time": "04:00",          // 重启时间（24小时制）
  "startup_script_path": "scripts/restart/start_bot.sh",  // 启动脚本路径
  "max_restart_attempts": 3,        // 最大重启尝试次数
  "restart_delay": 5                // 重启延迟秒数
}
```

## 🔧 快速开始

### 1. 环境检查和启动

```bash
# 检查环境和依赖
./scripts/restart/restart.sh test

# 启动机器人
./scripts/restart/restart.sh start

# 检查插件状态
./scripts/restart/restart.sh check

# 查看运行状态
./scripts/restart/restart.sh status
```

### 2. 功能测试

在QQ中发送给机器人（需要超级用户权限）：
- `@机器人 重启状态` - 查看系统状态
- `@机器人 重启配置` - 查看/修改配置
- `@机器人 重启` - 立即重启

## 📊 状态监控

### 重启状态信息

使用 `@机器人 重启状态` 可以查看：

- 🔄 自动重启开关状态
- ⏰ 当前设置的重启时间
- 📁 启动脚本路径
- 📅 最后重启时间
- ⏱️ 当前运行时长
- 🔢 历史重启次数

### 日志信息

```bash
# 查看最新日志
tail -f logs/$(ls logs/ | tail -1)

# 搜索重启相关日志
grep "重启" logs/*.log

# 查看重启过程日志
cat /tmp/atri_restart.log
```

## 🛡️ 安全特性

1. **权限控制**: 只有超级用户可以执行重启相关命令
2. **安全关闭**: 重启前会安全关闭当前进程，避免数据丢失
3. **状态记录**: 记录所有重启操作的时间和原因
4. **脚本清理**: 临时重启脚本会自动清理

## 🔍 故障排除

### 重启失败

如果重启失败，检查：

1. 启动脚本是否有执行权限
2. 虚拟环境路径是否正确
3. screen是否已安装
4. 查看重启日志：`cat /tmp/atri_restart.log`

### 定时任务不工作

检查：

1. 自动重启是否已启用
2. 时间格式是否正确（HH:MM）
3. 系统时区设置是否正确

### 脚本权限问题

```bash
# 添加执行权限
chmod +x scripts/restart/start_bot.sh
chmod +x scripts/restart/restart.sh
```

## 📝 重要说明

**注意**: 重启功能会完全关闭并重新启动机器人进程，正在进行的对话可能会被中断。建议在非繁忙时段使用。

---

**系统特性**:
- 自动检测并激活虚拟环境（`.venv`）
- 自动管理screen会话（默认会话名：`atri`）
- 安全的会话替换（关闭旧会话，启动新会话）
- 完整的错误处理和日志记录 